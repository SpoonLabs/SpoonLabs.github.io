<!DOCTYPE html>
<html lang="en">
<html>
  <head>

 <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content="processor,  processor, processing, annotations">
<title>Processor for annotations  | Spoon</title>
<link rel="stylesheet" type="text/css" href="css/syntax.css">
<link rel="stylesheet" type="text/css" href="css/font-awesome.min.css">
<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" href="css/modern-business.css">
<link rel="stylesheet" type="text/css" href="css/lavish-bootstrap.css">
<link rel="canonical" href="/processor_annotations.html">
<link rel="stylesheet" type="text/css" href="css/customstyles.css">
<link rel="stylesheet" type="text/css" href="css/theme-mauve.css">
<link rel="canonical" href="/processor_annotations.html">
<link rel="alternate" type="application/rss+xml" title="" href="feed.xml" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->







 

  <script>
    $(function () {
        $('[data-toggle="tooltip"]').tooltip()
    })
  </script>

  </head>

  <body>

   <!-- Navigation -->
<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-home fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> Spoon</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- entries without drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                




                
                
                
                
                <li><a href="papers.html">Papers</a></li>
                
                
                
                
                
                <li><a href="ecosystem.html">Ecosystem</a></li>
                
                
                
                
                
                <li><a href="about.html">About</a></li>
                
                
                
                
                
                <li><a href="https://ci.inria.fr/sos/" target="_blank">Jenkins</a></li>
                
                
                
                
                
                <li><a href="https://github.com/INRIA/spoon" target="_blank">Github</a></li>
                
                
                
                


                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->

                <li class="dropdown">
                    
        </div>
        <!-- /.container -->
</nav>


    <!-- Page Content -->
    <div class="container">
      <div class="col-lg-12">&nbsp;</div>

      <!-- Content Row -->
<div class="row">
    <!-- Sidebar Column -->
    <div class="col-md-3">

        <script>

            $(document).ready(function() {
                        // Initialize navgoco with default options
                        $("#mysidebar").navgoco({
                            caretHtml: '',
                            accordion: true,
                            openClass: 'active', // open
                            save: false, // leave false or nav highlighting doesn't work right
                            cookie: {
                                name: 'navgoco',
                                expires: false,
                                path: '/'
                        },
                        slide: {
                            duration: 400,
                            easing: 'swing'
                                }
                                });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

            });

        </script>


        




        <ul id="mysidebar" class="nav">

            <div class="siteTagline">Spoon</div>

            
            
            
            <li><a href="#">Getting started</a>
                <ul>
                    
                    
                    
                    <li><a href="first_analysis_processor.html">Code Analysis</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="architecture_test.html">Architecture Checking</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="reflection.html">Runtime Reflection</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="custom-pretty-printing.html">Custom Java Pretty-Printing</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="processor.html">Processor for elements</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="/mvnsites/spoon-core/apidocs" target="_blank">Javadoc</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="spoon_javadoc.html">Javadoc Analysis</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="faq.html">FAQ</a></li>
                    

                    
            </li>
            
            
            </ul>
        </li>
        
        
            
            <li><a href="#">Querying source code elements</a>
                <ul>
                    
                    
                    
                    <li><a href="filter.html">AST Traversing</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="path.html">AST Paths and Roles</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="matcher.html">Matcher</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="pattern.html">Pattern</a></li>
                    

                    
            </li>
            
            
            </ul>
        </li>
        
        
            
            <li><a href="#">Code Transformation</a>
                <ul>
                    
                    
                    
                    <li><a href="first_transformation.html">Code Transformation</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="examples.html">Transformation Examples</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li class="active"><a href="processor_annotations.html">Transformation with annotations</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="template_definition.html">Transformation with Templates</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="spoon_smpl.html">Semantic patching</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="pattern.html#generator">Code Generation</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="testing_quickstart.html">Testing transformations</a></li>
                    

                    
            </li>
            
            
            </ul>
        </li>
        
        
            
            <li><a href="#">Usage</a>
                <ul>
                    
                    
                    
                    <li><a href="launcher.html">From Java</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="command_line.html">Command Line</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="maven.html">From Maven Plugin</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="gradle.html">From Gradle Plugin</a></li>
                    

                    
            </li>
            
            
            </ul>
        </li>
        
        
            
            <li><a href="#">Spoon Meta model</a>
                <ul>
                    
                    
                    
                    <li><a href="structural_elements.html">Structural elements</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="code_elements.html">Code elements</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="references.html">References</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="factories.html">Create elements with factories</a></li>
                    

                    
            </li>
            
            
                    
                    
                    <li><a href="comments.html">Comments and Positions</a></li>
                    

                    
            </li>
            
            
            </ul>
        </li>
        
        
        
        </ul>

        
    </div>
       <!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above.-->
    <script>$("li.active").parents('li').toggleClass("active");</script>


      <!-- Content Column -->
      <div class="col-md-9">

          <div class="post-header">
   <h1 class="post-title-main">Processor for annotations</h1>
</div>

<div class="post-content">

   

  <p>We now discuss how Spoon deals with the processing of annotations. 
Java annotations enable developers to embed metadata in their programs. 
Although by themselves annotations have no explicit semantics, they can 
be used by frameworks as markers for altering the behavior of the programs 
that they annotate. This interpretation of annotations can result, for 
example, on the configuration of services provided by a middleware 
platform or on the alteration of the program source code.</p>

<p>Annotation processing is the process by which a pre-processor modifies an 
annotated program as directed by its annotations during a pre-compilation phase.
The Java compiler offers the possibility of compile-time processing of annotations 
via the API provided under the <code class="language-plaintext highlighter-rouge">javax.annotation.processing</code> package. Classes 
implementing the <code class="language-plaintext highlighter-rouge">javax.annotation.processing.Process</code> interface are used by the 
Java compiler to process annotations present in a client program. 
The client code is modeled by the classes of the <code class="language-plaintext highlighter-rouge">javax.lang.model</code> package 
(although Java 8 has introduced finer-grained annotations, but not on any 
arbitrary code elements). It is partially modeled: only types, methods, fields and 
parameter declarations can carry annotations. Furthermore, the model does not allow 
the developer to modify the client code, it only allows adding new classes.</p>

<p>The Spoon annotation processor overcomes those two limitations: it can handle 
annotations on any arbitrary code elements (including within method bodies), and it 
supports the modification of the existing code.</p>

<h3 id="annotation-processing-example">Annotation Processing Example</h3>

<p>Spoon provides developers with a way to specify the analyses and transformations 
associated with annotations. Annotations are metadata on code that start with <code class="language-plaintext highlighter-rouge">@</code> in Java.
For example, let us consider the example of a design-by-contract  annotation. 
The annotation <code class="language-plaintext highlighter-rouge">@NotNull</code>, when placed on arguments of a method, will ensure that the argument 
is not null when the method is executed. The code below shows both the definition of the 
<code class="language-plaintext highlighter-rouge">NotNull</code> annotation type, and an example of its use.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Target</span><span class="o">({</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">PARAMETER</span><span class="o">})</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">SOURCE</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">NotNull</span><span class="o">{}</span>

<span class="kd">class</span> <span class="nc">Person</span><span class="o">{</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">marry</span><span class="o">(</span><span class="nd">@NotNull</span> <span class="nc">Person</span> <span class="n">so</span><span class="o">){</span>
		<span class="k">if</span><span class="o">(!</span><span class="n">so</span><span class="o">.</span><span class="na">isMarried</span><span class="o">())</span>
			<span class="c1">// Marrying logic...</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">NotNull</code> annotation type definition carries two meta-annotations (annotations on annotation 
definitions) stating which source code elements can be annotated (line 1), and that the annotation 
is intended for compile-time processing (line 2). The <code class="language-plaintext highlighter-rouge">NotNull</code> annotation is used on the argument 
of the <code class="language-plaintext highlighter-rouge">marry</code> method of the class <code class="language-plaintext highlighter-rouge">Person</code>. Without annotation processing, if the method <code class="language-plaintext highlighter-rouge">marry</code> 
is invoked with a <code class="language-plaintext highlighter-rouge">null</code> reference, a <code class="language-plaintext highlighter-rouge">NullPointerException</code> would be thrown by the Java virtual 
machine when invoking the method <code class="language-plaintext highlighter-rouge">isMarried</code> in line 7.</p>

<p>The implementation of such an annotation would not be straightforward using Java’s processing API 
since it would not allow us to just insert the NULL check in the body of the annotated method.</p>

<h3 id="the-annotation-processor-interface">The Annotation Processor Interface</h3>

<p>In Spoon, the full code model can be used  for compile-time annotation processing. To this end, 
Spoon provides a special kind of processor called <code class="language-plaintext highlighter-rouge">AnnotationProcessor</code> whose interface is:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">AnnotationProcessor</span><span class="o">&lt;</span><span class="no">A</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">,</span> <span class="no">E</span> <span class="kd">extends</span> <span class="nc">CtElement</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">Processor</span><span class="o">&lt;</span><span class="no">E</span><span class="o">&gt;</span> <span class="o">{</span>
	<span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="no">A</span> <span class="n">annotation</span><span class="o">,</span> <span class="no">E</span> <span class="n">element</span><span class="o">);</span>
	<span class="kt">boolean</span> <span class="nf">inferConsumedAnnotationType</span><span class="o">();</span>
	<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">A</span><span class="o">&gt;&gt;</span> <span class="nf">getProcessedAnnotationTypes</span><span class="o">();</span>
	<span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="no">A</span><span class="o">&gt;&gt;</span> <span class="nf">getConsumedAnnotationTypes</span><span class="o">();</span>
	<span class="kt">boolean</span> <span class="nf">shoudBeConsumed</span><span class="o">(</span><span class="nc">CtAnnotation</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Annotation</span><span class="o">&gt;</span> <span class="n">annotation</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Annotation processors extend normal processors by stating the annotation type those elements must 
carry (type parameter <code class="language-plaintext highlighter-rouge">A</code>), in addition of stating the kind of source code element they process 
(type parameter <code class="language-plaintext highlighter-rouge">E</code>). The <code class="language-plaintext highlighter-rouge">process</code> method (line 4) receives as arguments both the <code class="language-plaintext highlighter-rouge">CtElement</code> and the 
annotation it carries. The remaining four methods (<code class="language-plaintext highlighter-rouge">getProcessedAnnotationTypes</code>, <code class="language-plaintext highlighter-rouge">getConsumedAnnotationTypes</code>, 
<code class="language-plaintext highlighter-rouge">inferConsumedAnnotationTypes</code> and <code class="language-plaintext highlighter-rouge">shoudBeConsumed</code>) configure the visiting of the AST during annotation 
processing. The Spoon annotation processing runtime is able to infer the type of annotation a processor 
handles from its type parameter <code class="language-plaintext highlighter-rouge">A</code>. This restricts each processor to handle a single annotation. To avoid this 
restriction, a developer can override the <code class="language-plaintext highlighter-rouge">inferConsumedAnnotationType()</code> method to return <code class="language-plaintext highlighter-rouge">false</code>. When doing 
this, Spoon queries the <code class="language-plaintext highlighter-rouge">getProcessedAnnotationTypes()</code> method to find out which annotations are handled by the 
processor. Finally, the <code class="language-plaintext highlighter-rouge">getConsumedAnnotationTypes()</code> returns the set of processed annotations that are to be 
consumed by the annotation processor. Consumed annotations are not available in later processing rounds. 
Similar to standard processors, Spoon provides a default abstract implementation for annotation processors: 
<code class="language-plaintext highlighter-rouge">AbstractAnnotationProcessor</code>. It provides facilities for maintaining the list of consumed and processed annotation 
types, allowing the developer to concentrate on the implementation of the annotation processing logic.</p>

<p>Going back to our <code class="language-plaintext highlighter-rouge">@NotNull</code> example, we implement a Spoon annotation processor that processes and consumes 
<code class="language-plaintext highlighter-rouge">NotNull</code> annotated method parameters, and modifies the source code of the method by inserting an <code class="language-plaintext highlighter-rouge">assert</code> statement 
that checks that the argument is not null.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">NotNullProcessor</span> <span class="kd">extends</span> <span class="nc">AbstractAnnotationProcessor</span><span class="o">&lt;</span><span class="nc">NotNull</span><span class="o">,</span> <span class="nc">CtParameter</span><span class="o">&gt;</span> <span class="o">{</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="nc">NotNull</span> <span class="n">anno</span><span class="o">,</span> <span class="nc">CtParameter</span> <span class="n">param</span><span class="o">){</span>
		<span class="nc">CtMethod</span><span class="o">&lt;?&gt;</span> <span class="n">method</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="na">getParent</span><span class="o">(</span><span class="nc">CtMethod</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
		<span class="nc">CtBlock</span><span class="o">&lt;?&gt;</span> <span class="n">body</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getBlock</span><span class="o">();</span>
		<span class="nc">CtAssert</span><span class="o">&lt;?&gt;</span> <span class="n">assertion</span> <span class="o">=</span> <span class="n">constructAssertion</span><span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">());</span>
		<span class="n">body</span><span class="o">.</span><span class="na">insertBegin</span><span class="o">(</span><span class="n">assertion</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">NotNullProcessor</code> leverages the default implementation provided by the <code class="language-plaintext highlighter-rouge">AbstractAnnotationProcessor</code> and binds the 
type variables representing the annotation to be processed and the annotated code elements to <code class="language-plaintext highlighter-rouge">NotNull</code> and <code class="language-plaintext highlighter-rouge">CtParameter</code> 
respectively. The actual processing of the annotation is implemented in the <code class="language-plaintext highlighter-rouge">process(NotNull,CtParameter)</code> method 
(lines 10-13). Annotated code is transformed by navigating the AST up from the annotated parameter to the owner method, 
and then down to the method’s body code block (lines 10 and 12). The construction of the <code class="language-plaintext highlighter-rouge">assert</code> statement is delegated 
to a helper method <code class="language-plaintext highlighter-rouge">constructAssertion(String)</code>, taking as argument the name of the parameter to check. This helper method 
constructs an instance of <code class="language-plaintext highlighter-rouge">CtAssert</code> by programmatically constructing the desired boolean expression. Having obtained 
the desired assert statement, it is injected at the beginning of the body of the method.</p>

<p>More complex annotation processing scenarios can be tackled with Spoon. For example, when using the <code class="language-plaintext highlighter-rouge">NotNull</code> annotation, 
the developer is still responsible for manually inspecting which method parameters to place the annotation on. 
A common processing pattern is then to use regular Spoon processors to <code class="language-plaintext highlighter-rouge">auto-annotate</code> the application’s source code. 
Such a processor, in our running example, can traverse the body of a method, looking for expressions that send messages 
to a parameter. Each of these expressions  has as hypothesis that the parameter’s value is not null, and thus should result 
in the parameter being annotated with <code class="language-plaintext highlighter-rouge">NotNull</code>.</p>

<p>With this processing pattern, the programmer can use an annotation processor in two ways: either by explicitly and manually 
annotating the base program, or by using a processor that analyzes and annotates the program for triggering annotation processors 
in an automatic and implicit way. This design decouples the program analysis from the program transformation logics, and leaves 
room for manual configuration.</p>






















































































































































</div>

<hr class="shaded"/> 

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
               	<a href="https://github.com/INRIA/spoon/issues/new">Contact / Feedback / Question / Bug Report</a><br />
                </div>
            </div>
        </footer>

      </div><!-- /.row -->

    </div>    <!-- /.container -->

  </body>

  
  <!-- the google_analytics_id gets auto inserted from the config file -->


<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-24273081-1', 'auto');
    ga('send', 'pageview');
</script>

  

</html>

